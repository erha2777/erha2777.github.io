<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"><title>webpack高级 | erha blog</title><meta name="author" content="erha"><meta name="copyright" content="erha"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="loader 原理loader 概念帮助 webpack 将不同类型的文件转换为 webpack 可识别的模块。 loader 执行顺序 分类   pre： 前置 loader normal： 普通 loader inline： 内联 loader post： 后置 loader   执行顺序"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/2023/02/06/webpack%E9%AB%98%E7%BA%A7/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: true,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  }
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'webpack高级',
  isPost: true,
  isHome: false,
  isHighlightShrink: true,
  isToc: true,
  postUpdate: '2023-02-06 11:24:46'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = url => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      link.onload = () => resolve()
      link.onerror = () => reject()
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 5.4.2"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://pic.imgdb.cn/item/63e0f1d14757feff33865eb7.gif" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">53</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">48</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">22</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首頁</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-heartbeat"></i><span> 清单</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音樂</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 電影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://pic.imgdb.cn/item/63dfbedd4757feff33d34240.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="erha blog"><span class="site-name">erha blog</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首頁</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-heartbeat"></i><span> 清单</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音樂</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 電影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">webpack高级</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-02-06T03:17:14.615Z" title="发表于 2023-02-06 11:17:14">2023-02-06</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-02-06T03:24:46.890Z" title="更新于 2023-02-06 11:24:46">2023-02-06</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/webpack/">webpack</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="webpack高级"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="loader-原理"><a href="#loader-原理" class="headerlink" title="loader 原理"></a>loader 原理</h1><h2 id="loader-概念"><a href="#loader-概念" class="headerlink" title="loader 概念"></a>loader 概念</h2><p>帮助 webpack 将不同类型的文件转换为 webpack 可识别的模块。</p>
<h2 id="loader-执行顺序"><a href="#loader-执行顺序" class="headerlink" title="loader 执行顺序"></a>loader 执行顺序</h2><ol>
<li>分类</li>
</ol>
<ul>
<li>pre： 前置 loader</li>
<li>normal： 普通 loader</li>
<li>inline： 内联 loader</li>
<li>post： 后置 loader</li>
</ul>
<ol>
<li>执行顺序</li>
</ol>
<ul>
<li>4 类 loader 的执行优级为：<code>pre &gt; normal &gt; inline &gt; post</code> 。</li>
<li>相同优先级的 loader 执行顺序为：<code>从右到左，从下到上</code>。</li>
</ul>
<p>例如：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 此时loader执行顺序：loader3 - loader2 - loader1</span></span><br><span class="line"><span class="built_in">module</span>: &#123;</span><br><span class="line">  rules: [</span><br><span class="line">    &#123;</span><br><span class="line">      test: <span class="regexp">/\.js$/</span>,</span><br><span class="line">      loader: <span class="string">&quot;loader1&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      test: <span class="regexp">/\.js$/</span>,</span><br><span class="line">      loader: <span class="string">&quot;loader2&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      test: <span class="regexp">/\.js$/</span>,</span><br><span class="line">      loader: <span class="string">&quot;loader3&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  ],</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 此时loader执行顺序：loader1 - loader2 - loader3</span></span><br><span class="line"><span class="built_in">module</span>: &#123;</span><br><span class="line">  rules: [</span><br><span class="line">    &#123;</span><br><span class="line">      enforce: <span class="string">&quot;pre&quot;</span>,</span><br><span class="line">      test: <span class="regexp">/\.js$/</span>,</span><br><span class="line">      loader: <span class="string">&quot;loader1&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">// 没有enforce就是normal</span></span><br><span class="line">      test: <span class="regexp">/\.js$/</span>,</span><br><span class="line">      loader: <span class="string">&quot;loader2&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      enforce: <span class="string">&quot;post&quot;</span>,</span><br><span class="line">      test: <span class="regexp">/\.js$/</span>,</span><br><span class="line">      loader: <span class="string">&quot;loader3&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  ],</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>使用 loader 的方式</li>
</ol>
<ul>
<li>配置方式：在 <code>webpack.config.js</code> 文件中指定 loader。（pre、normal、post loader）</li>
<li>内联方式：在每个 <code>import</code> 语句中显式指定 loader。（inline loader）</li>
</ul>
<ol start="4">
<li>inline loader</li>
</ol>
<p>用法：<code>import Styles from &#39;style-loader!css-loader?modules!./styles.css&#39;;</code></p>
<p>含义：</p>
<ul>
<li>使用 <code>css-loader</code> 和 <code>style-loader</code> 处理 <code>styles.css</code> 文件</li>
<li>通过 <code>!</code> 将资源中的 loader 分开</li>
</ul>
<p><code>inline loader</code> 可以通过添加不同前缀，跳过其他类型 loader。</p>
<ul>
<li><code>!</code> 跳过 normal loader。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">import Styles from &#39;!style-loader!css-loader?modules!.&#x2F;styles.css&#39;;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>-!</code> 跳过 pre 和 normal loader。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">import Styles from &#39;-!style-loader!css-loader?modules!.&#x2F;styles.css&#39;;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>!!</code> 跳过 pre、 normal 和 post loader。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">import Styles from &#39;!!style-loader!css-loader?modules!.&#x2F;styles.css&#39;;</span><br></pre></td></tr></table></figure>



<h2 id="开发一个-loader"><a href="#开发一个-loader" class="headerlink" title="开发一个 loader"></a>开发一个 loader</h2><h3 id="1-最简单的-loader"><a href="#1-最简单的-loader" class="headerlink" title="1. 最简单的 loader"></a>1. 最简单的 loader</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// loaders/loader1.js</span></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> <span class="title">loader1</span>(<span class="params">content</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&quot;hello loader&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> content;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>它接受要处理的源码作为参数，输出转换后的 js 代码。</p>
<h3 id="2-loader-接受的参数"><a href="#2-loader-接受的参数" class="headerlink" title="2. loader 接受的参数"></a>2. loader 接受的参数</h3><ul>
<li><code>content</code> 源文件的内容</li>
<li><code>map</code> SourceMap 数据</li>
<li><code>meta</code> 数据，可以是任何内容</li>
</ul>
<h2 id="loader-分类"><a href="#loader-分类" class="headerlink" title="loader 分类"></a>loader 分类</h2><h3 id="1-同步-loader"><a href="#1-同步-loader" class="headerlink" title="1. 同步 loader"></a>1. 同步 loader</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> (<span class="params">content, map, meta</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> content;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>this.callback</code> 方法则更灵活，因为它允许传递多个参数，而不仅仅是 <code>content</code>。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> (<span class="params">content, map, meta</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 传递map，让source-map不中断</span></span><br><span class="line">  <span class="comment">// 传递meta，让下一个loader接收到其他参数</span></span><br><span class="line">  <span class="built_in">this</span>.callback(<span class="literal">null</span>, content, map, meta);</span><br><span class="line">  <span class="keyword">return</span>; <span class="comment">// 当调用 callback() 函数时，总是返回 undefined</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="2-异步-loader"><a href="#2-异步-loader" class="headerlink" title="2. 异步 loader"></a>2. 异步 loader</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> (<span class="params">content, map, meta</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> callback = <span class="built_in">this</span>.async();</span><br><span class="line">  <span class="comment">// 进行异步操作</span></span><br><span class="line">  <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    callback(<span class="literal">null</span>, result, map, meta);</span><br><span class="line">  &#125;, <span class="number">1000</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>由于同步计算过于耗时，在 Node.js 这样的单线程环境下进行此操作并不是好的方案，我们建议尽可能地使你的 loader 异步化。但如果计算量很小，同步 loader 也是可以的。</p>
</blockquote>
<h3 id="3-Raw-Loader"><a href="#3-Raw-Loader" class="headerlink" title="3. Raw Loader"></a>3. Raw Loader</h3><p>默认情况下，资源文件会被转化为 UTF-8 字符串，然后传给 loader。通过设置 raw 为 true，loader 可以接收原始的 Buffer。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> (<span class="params">content</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// content是一个Buffer数据</span></span><br><span class="line">  <span class="keyword">return</span> content;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">module</span>.exports.raw = <span class="literal">true</span>; <span class="comment">// 开启 Raw Loader</span></span><br></pre></td></tr></table></figure>

<h3 id="4-Pitching-Loader"><a href="#4-Pitching-Loader" class="headerlink" title="4. Pitching Loader"></a>4. Pitching Loader</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> (<span class="params">content</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> content;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">module</span>.exports.pitch = <span class="function"><span class="keyword">function</span> (<span class="params">remainingRequest, precedingRequest, data</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&quot;do somethings&quot;</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>webpack 会先从左到右执行 loader 链中的每个 loader 上的 pitch 方法（如果有），然后再从右到左执行 loader 链中的每个 loader 上的普通 loader 方法。</p>
<p><img src="http://192.168.0.102:8080/imgs/source/loader1.png" alt="loader执行流程"></p>
<p>在这个过程中如果任何 pitch 有返回值，则 loader 链被阻断。webpack 会跳过后面所有的的 pitch 和 loader，直接进入上一个 loader 。</p>
<p><img src="http://192.168.0.102:8080/imgs/source/loader2.png" alt="loader执行流程"></p>
<h2 id="loader-API"><a href="#loader-API" class="headerlink" title="loader API"></a>loader API</h2><table>
<thead>
<tr>
<th>方法名</th>
<th>含义</th>
<th>用法</th>
</tr>
</thead>
<tbody><tr>
<td>this.async</td>
<td>异步回调 loader。返回 this.callback</td>
<td>const callback = this.async()</td>
</tr>
<tr>
<td>this.callback</td>
<td>可以同步或者异步调用的并返回多个结果的函数</td>
<td>this.callback(err, content, sourceMap?, meta?)</td>
</tr>
<tr>
<td>this.getOptions(schema)</td>
<td>获取 loader 的 options</td>
<td>this.getOptions(schema)</td>
</tr>
<tr>
<td>this.emitFile</td>
<td>产生一个文件</td>
<td>this.emitFile(name, content, sourceMap)</td>
</tr>
<tr>
<td>this.utils.contextify</td>
<td>返回一个相对路径</td>
<td>this.utils.contextify(context, request)</td>
</tr>
<tr>
<td>this.utils.absolutify</td>
<td>返回一个绝对路径</td>
<td>this.utils.absolutify(context, request)</td>
</tr>
</tbody></table>
<blockquote>
<p>更多文档，请查阅 <a target="_blank" rel="noopener" href="https://webpack.docschina.org/api/loaders/#the-loader-context">webpack 官方 loader api 文档</a></p>
</blockquote>
<h2 id="手写-clean-log-loader"><a href="#手写-clean-log-loader" class="headerlink" title="手写 clean-log-loader"></a>手写 clean-log-loader</h2><p>作用：用来清理 js 代码中的<code>console.log</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// loaders/clean-log-loader.js</span></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> <span class="title">cleanLogLoader</span>(<span class="params">content</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 将console.log替换为空</span></span><br><span class="line">  <span class="keyword">return</span> content.replace(<span class="regexp">/console\.log\(.*\);?/g</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<h2 id="手写-banner-loader"><a href="#手写-banner-loader" class="headerlink" title="手写 banner-loader"></a>手写 banner-loader</h2><p>作用：给 js 代码添加文本注释</p>
<ul>
<li>loaders/banner-loader/index.js</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> schema = <span class="built_in">require</span>(<span class="string">&quot;./schema.json&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> (<span class="params">content</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 获取loader的options，同时对options内容进行校验</span></span><br><span class="line">  <span class="comment">// schema是options的校验规则（符合 JSON schema 规则）</span></span><br><span class="line">  <span class="keyword">const</span> options = <span class="built_in">this</span>.getOptions(schema);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> prefix = <span class="string">`</span></span><br><span class="line"><span class="string">    /*</span></span><br><span class="line"><span class="string">    * Author: <span class="subst">$&#123;options.author&#125;</span></span></span><br><span class="line"><span class="string">    */</span></span><br><span class="line"><span class="string">  `</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="string">`<span class="subst">$&#123;prefix&#125;</span> \n <span class="subst">$&#123;content&#125;</span>`</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li>loaders/banner-loader/schema.json</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;object&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;properties&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;author&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;string&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;additionalProperties&quot;</span>: <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="手写-babel-loader"><a href="#手写-babel-loader" class="headerlink" title="手写 babel-loader"></a>手写 babel-loader</h2><p>作用：编译 js 代码，将 ES6+语法编译成 ES5-语法。</p>
<ul>
<li>下载依赖</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i @babel/core @babel/preset-env -D</span><br></pre></td></tr></table></figure>

<ul>
<li>loaders/babel-loader/index.js</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> schema = <span class="built_in">require</span>(<span class="string">&quot;./schema.json&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> babel = <span class="built_in">require</span>(<span class="string">&quot;@babel/core&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> (<span class="params">content</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> options = <span class="built_in">this</span>.getOptions(schema);</span><br><span class="line">  <span class="comment">// 使用异步loader</span></span><br><span class="line">  <span class="keyword">const</span> callback = <span class="built_in">this</span>.async();</span><br><span class="line">  <span class="comment">// 使用babel对js代码进行编译</span></span><br><span class="line">  babel.transform(content, options, <span class="function"><span class="keyword">function</span> (<span class="params">err, result</span>) </span>&#123;</span><br><span class="line">    callback(err, result.code);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li>loaders/banner-loader/schema.json</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;object&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;properties&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;presets&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;array&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;additionalProperties&quot;</span>: <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="手写-file-loader"><a href="#手写-file-loader" class="headerlink" title="手写 file-loader"></a>手写 file-loader</h2><p>作用：将文件原封不动输出出去</p>
<ul>
<li>下载包</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i loader-utils -D</span><br></pre></td></tr></table></figure>

<ul>
<li>loaders/file-loader.js</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> loaderUtils = <span class="built_in">require</span>(<span class="string">&quot;loader-utils&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fileLoader</span>(<span class="params">content</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 根据文件内容生产一个新的文件名称</span></span><br><span class="line">  <span class="keyword">const</span> filename = loaderUtils.interpolateName(<span class="built_in">this</span>, <span class="string">&quot;[hash].[ext]&quot;</span>, &#123;</span><br><span class="line">    content,</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="comment">// 输出文件</span></span><br><span class="line">  <span class="built_in">this</span>.emitFile(filename, content);</span><br><span class="line">  <span class="comment">// 暴露出去，给js引用。</span></span><br><span class="line">  <span class="comment">// 记得加上&#x27;&#x27;</span></span><br><span class="line">  <span class="keyword">return</span> <span class="string">`export default &#x27;<span class="subst">$&#123;filename&#125;</span>&#x27;`</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// loader 解决的是二进制的内容</span></span><br><span class="line"><span class="comment">// 图片是 Buffer 数据</span></span><br><span class="line">fileLoader.raw = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = fileLoader;</span><br></pre></td></tr></table></figure>

<ul>
<li>loader 配置</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  test: <span class="regexp">/\.(png|jpe?g|gif)$/</span>,</span><br><span class="line">  loader: <span class="string">&quot;./loaders/file-loader.js&quot;</span>,</span><br><span class="line">  type: <span class="string">&quot;javascript/auto&quot;</span>, <span class="comment">// 解决图片重复打包问题</span></span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>



<h2 id="手写-style-loader"><a href="#手写-style-loader" class="headerlink" title="手写 style-loader"></a>手写 style-loader</h2><p>作用：动态创建 style 标签，插入 js 中的样式代码，使样式生效。</p>
<ul>
<li>loaders/style-loader.js</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> styleLoader = <span class="function">() =&gt;</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">styleLoader.pitch = <span class="function"><span class="keyword">function</span> (<span class="params">remainingRequest</span>) </span>&#123;</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    remainingRequest: C:\Users\86176\Desktop\source\node_modules\css-loader\dist\cjs.js!C:\Users\86176\Desktop\source\src\css\index.css</span></span><br><span class="line"><span class="comment">      这里是inline loader用法，代表后面还有一个css-loader等待处理</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    最终我们需要将remainingRequest中的路径转化成相对路径，webpack才能处理</span></span><br><span class="line"><span class="comment">      希望得到：../../node_modules/css-loader/dist/cjs.js!./index.css</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    所以：需要将绝对路径转化成相对路径</span></span><br><span class="line"><span class="comment">    要求：</span></span><br><span class="line"><span class="comment">      1. 必须是相对路径</span></span><br><span class="line"><span class="comment">      2. 相对路径必须以 ./ 或 ../ 开头</span></span><br><span class="line"><span class="comment">      3. 相对路径的路径分隔符必须是 / ，不能是 \</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="keyword">const</span> relativeRequest = remainingRequest</span><br><span class="line">    .split(<span class="string">&quot;!&quot;</span>)</span><br><span class="line">    .map(<span class="function">(<span class="params">part</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// 将路径转化为相对路径</span></span><br><span class="line">      <span class="keyword">const</span> relativePath = <span class="built_in">this</span>.utils.contextify(<span class="built_in">this</span>.context, part);</span><br><span class="line">      <span class="keyword">return</span> relativePath;</span><br><span class="line">    &#125;)</span><br><span class="line">    .join(<span class="string">&quot;!&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    !!$&#123;relativeRequest&#125; </span></span><br><span class="line"><span class="comment">      relativeRequest：../../node_modules/css-loader/dist/cjs.js!./index.css</span></span><br><span class="line"><span class="comment">      relativeRequest是inline loader用法，代表要处理的index.css资源, 使用css-loader处理</span></span><br><span class="line"><span class="comment">      !!代表禁用所有配置的loader，只使用inline loader。（也就是外面我们style-loader和css-loader）,它们被禁用了，只是用我们指定的inline loader，也就是css-loader</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    import style from &quot;!!$&#123;relativeRequest&#125;&quot;</span></span><br><span class="line"><span class="comment">      引入css-loader处理后的css文件</span></span><br><span class="line"><span class="comment">      为什么需要css-loader处理css文件，不是我们直接读取css文件使用呢？</span></span><br><span class="line"><span class="comment">      因为可能存在@import导入css语法，这些语法就要通过css-loader解析才能变成一个css文件，否则我们引入的css资源会缺少</span></span><br><span class="line"><span class="comment">    const styleEl = document.createElement(&#x27;style&#x27;)</span></span><br><span class="line"><span class="comment">      动态创建style标签</span></span><br><span class="line"><span class="comment">    styleEl.innerHTML = style</span></span><br><span class="line"><span class="comment">      将style标签内容设置为处理后的css代码</span></span><br><span class="line"><span class="comment">    document.head.appendChild(styleEl)</span></span><br><span class="line"><span class="comment">      添加到head中生效</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="keyword">const</span> script = <span class="string">`</span></span><br><span class="line"><span class="string">    import style from &quot;!!<span class="subst">$&#123;relativeRequest&#125;</span>&quot;</span></span><br><span class="line"><span class="string">    const styleEl = document.createElement(&#x27;style&#x27;)</span></span><br><span class="line"><span class="string">    styleEl.innerHTML = style</span></span><br><span class="line"><span class="string">    document.head.appendChild(styleEl)</span></span><br><span class="line"><span class="string">  `</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// style-loader是第一个loader, 由于return导致熔断，所以其他loader不执行了（不管是normal还是pitch）</span></span><br><span class="line">  <span class="keyword">return</span> script;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = styleLoader;</span><br></pre></td></tr></table></figure>





<h1 id="Plugin-原理"><a href="#Plugin-原理" class="headerlink" title="Plugin 原理"></a>Plugin 原理</h1><h2 id="Plugin-的作用"><a href="#Plugin-的作用" class="headerlink" title="Plugin 的作用"></a>Plugin 的作用</h2><p>通过插件我们可以扩展 webpack，加入自定义的构建行为，使 webpack 可以执行更广泛的任务，拥有更强的构建能力。</p>
<h2 id="Plugin-工作原理"><a href="#Plugin-工作原理" class="headerlink" title="Plugin 工作原理"></a>Plugin 工作原理</h2><blockquote>
<p>webpack 就像一条生产线，要经过一系列处理流程后才能将源文件转换成输出结果。 这条生产线上的每个处理流程的职责都是单一的，多个流程之间有存在依赖关系，只有完成当前处理后才能交给下一个流程去处理。 插件就像是一个插入到生产线中的一个功能，在特定的时机对生产线上的资源做处理。webpack 通过 Tapable 来组织这条复杂的生产线。 webpack 在运行过程中会广播事件，插件只需要监听它所关心的事件，就能加入到这条生产线中，去改变生产线的运作。 webpack 的事件流机制保证了插件的有序性，使得整个系统扩展性很好。 ——「深入浅出 Webpack」</p>
</blockquote>
<p>站在代码逻辑的角度就是：webpack 在编译代码过程中，会触发一系列 <code>Tapable</code> 钩子事件，插件所做的，就是找到相应的钩子，往上面挂上自己的任务，也就是注册事件，这样，当 webpack 构建的时候，插件注册的事件就会随着钩子的触发而执行了。</p>
<h2 id="Webpack-内部的钩子"><a href="#Webpack-内部的钩子" class="headerlink" title="Webpack 内部的钩子"></a>Webpack 内部的钩子</h2><h3 id="什么是钩子"><a href="#什么是钩子" class="headerlink" title="什么是钩子"></a>什么是钩子</h3><p>钩子的本质就是：事件。为了方便我们直接介入和控制编译过程，webpack 把编译过程中触发的各类关键事件封装成事件接口暴露了出来。这些接口被很形象地称做：<code>hooks</code>（钩子）。开发插件，离不开这些钩子。</p>
<h3 id="Tapable"><a href="#Tapable" class="headerlink" title="Tapable"></a>Tapable</h3><p><code>Tapable</code> 为 webpack 提供了统一的插件接口（钩子）类型定义，它是 webpack 的核心功能库。webpack 中目前有十种 <code>hooks</code>，在 <code>Tapable</code> 源码中可以看到，他们是：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/webpack/tapable/blob/master/lib/index.js</span></span><br><span class="line"><span class="built_in">exports</span>.SyncHook = <span class="built_in">require</span>(<span class="string">&quot;./SyncHook&quot;</span>);</span><br><span class="line"><span class="built_in">exports</span>.SyncBailHook = <span class="built_in">require</span>(<span class="string">&quot;./SyncBailHook&quot;</span>);</span><br><span class="line"><span class="built_in">exports</span>.SyncWaterfallHook = <span class="built_in">require</span>(<span class="string">&quot;./SyncWaterfallHook&quot;</span>);</span><br><span class="line"><span class="built_in">exports</span>.SyncLoopHook = <span class="built_in">require</span>(<span class="string">&quot;./SyncLoopHook&quot;</span>);</span><br><span class="line"><span class="built_in">exports</span>.AsyncParallelHook = <span class="built_in">require</span>(<span class="string">&quot;./AsyncParallelHook&quot;</span>);</span><br><span class="line"><span class="built_in">exports</span>.AsyncParallelBailHook = <span class="built_in">require</span>(<span class="string">&quot;./AsyncParallelBailHook&quot;</span>);</span><br><span class="line"><span class="built_in">exports</span>.AsyncSeriesHook = <span class="built_in">require</span>(<span class="string">&quot;./AsyncSeriesHook&quot;</span>);</span><br><span class="line"><span class="built_in">exports</span>.AsyncSeriesBailHook = <span class="built_in">require</span>(<span class="string">&quot;./AsyncSeriesBailHook&quot;</span>);</span><br><span class="line"><span class="built_in">exports</span>.AsyncSeriesLoopHook = <span class="built_in">require</span>(<span class="string">&quot;./AsyncSeriesLoopHook&quot;</span>);</span><br><span class="line"><span class="built_in">exports</span>.AsyncSeriesWaterfallHook = <span class="built_in">require</span>(<span class="string">&quot;./AsyncSeriesWaterfallHook&quot;</span>);</span><br><span class="line"><span class="built_in">exports</span>.HookMap = <span class="built_in">require</span>(<span class="string">&quot;./HookMap&quot;</span>);</span><br><span class="line"><span class="built_in">exports</span>.MultiHook = <span class="built_in">require</span>(<span class="string">&quot;./MultiHook&quot;</span>);</span><br></pre></td></tr></table></figure>

<p><code>Tapable</code> 还统一暴露了三个方法给插件，用于注入不同类型的自定义构建行为：</p>
<ul>
<li><code>tap</code>：可以注册同步钩子和异步钩子。</li>
<li><code>tapAsync</code>：回调方式注册异步钩子。</li>
<li><code>tapPromise</code>：Promise 方式注册异步钩子。</li>
</ul>
<h2 id="Plugin-构建对象"><a href="#Plugin-构建对象" class="headerlink" title="Plugin 构建对象"></a>Plugin 构建对象</h2><h3 id="Compiler"><a href="#Compiler" class="headerlink" title="Compiler"></a>Compiler</h3><p>compiler 对象中保存着完整的 Webpack 环境配置，每次启动 webpack 构建时它都是一个独一无二，仅仅会创建一次的对象。</p>
<p>这个对象会在首次启动 Webpack 时创建，我们可以通过 compiler 对象上访问到 Webapck 的主环境配置，比如 loader 、 plugin 等等配置信息。</p>
<p>它有以下主要属性：</p>
<ul>
<li><code>compiler.options</code> 可以访问本次启动 webpack 时候所有的配置文件，包括但不限于 loaders 、 entry 、 output 、 plugin 等等完整配置信息。</li>
<li><code>compiler.inputFileSystem</code> 和 <code>compiler.outputFileSystem</code> 可以进行文件操作，相当于 Nodejs 中 fs。</li>
<li><code>compiler.hooks</code> 可以注册 tapable 的不同种类 Hook，从而可以在 compiler 生命周期中植入不同的逻辑。</li>
</ul>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://webpack.docschina.org/api/compiler-hooks/">compiler hooks 文档</a></p>
</blockquote>
<h3 id="Compilation"><a href="#Compilation" class="headerlink" title="Compilation"></a>Compilation</h3><p>compilation 对象代表一次资源的构建，compilation 实例能够访问所有的模块和它们的依赖。</p>
<p>一个 compilation 对象会对构建依赖图中所有模块，进行编译。 在编译阶段，模块会被加载(load)、封存(seal)、优化(optimize)、 分块(chunk)、哈希(hash)和重新创建(restore)。</p>
<p>它有以下主要属性：</p>
<ul>
<li><code>compilation.modules</code> 可以访问所有模块，打包的每一个文件都是一个模块。</li>
<li><code>compilation.chunks</code> chunk 即是多个 modules 组成而来的一个代码块。入口文件引入的资源组成一个 chunk，通过代码分割的模块又是另外的 chunk。</li>
<li><code>compilation.assets</code> 可以访问本次打包生成所有文件的结果。</li>
<li><code>compilation.hooks</code> 可以注册 tapable 的不同种类 Hook，用于在 compilation 编译模块阶段进行逻辑添加以及修改。</li>
</ul>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://webpack.docschina.org/api/compilation-hooks/">compilation hooks 文档</a></p>
</blockquote>
<h3 id="生命周期简图"><a href="#生命周期简图" class="headerlink" title="生命周期简图"></a>生命周期简图</h3><p><img src="http://192.168.0.102:8080/imgs/source/plugin.jpg" alt="Webpack 插件生命周期"></p>
<h2 id="开发一个插件"><a href="#开发一个插件" class="headerlink" title="开发一个插件"></a>开发一个插件</h2><h3 id="最简单的插件"><a href="#最简单的插件" class="headerlink" title="最简单的插件"></a>最简单的插件</h3><ul>
<li>plugins/test-plugin.js</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestPlugin</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;TestPlugin constructor()&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 1. webpack读取配置时，new TestPlugin() ，会执行插件 constructor 方法</span></span><br><span class="line">  <span class="comment">// 2. webpack创建 compiler 对象</span></span><br><span class="line">  <span class="comment">// 3. 遍历所有插件，调用插件的 apply 方法</span></span><br><span class="line">  <span class="function"><span class="title">apply</span>(<span class="params">compiler</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;TestPlugin apply()&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = TestPlugin;</span><br></pre></td></tr></table></figure>



<h3 id="注册-hook"><a href="#注册-hook" class="headerlink" title="注册 hook"></a>注册 hook</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestPlugin</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;TestPlugin constructor()&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 1. webpack读取配置时，new TestPlugin() ，会执行插件 constructor 方法</span></span><br><span class="line">  <span class="comment">// 2. webpack创建 compiler 对象</span></span><br><span class="line">  <span class="comment">// 3. 遍历所有插件，调用插件的 apply 方法</span></span><br><span class="line">  <span class="function"><span class="title">apply</span>(<span class="params">compiler</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;TestPlugin apply()&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从文档可知, compile hook 是 SyncHook, 也就是同步钩子, 只能用tap注册</span></span><br><span class="line">    compiler.hooks.compile.tap(<span class="string">&quot;TestPlugin&quot;</span>, <span class="function">(<span class="params">compilationParams</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">&quot;compiler.compile()&quot;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从文档可知, make 是 AsyncParallelHook, 也就是异步并行钩子, 特点就是异步任务同时执行</span></span><br><span class="line">    <span class="comment">// 可以使用 tap、tapAsync、tapPromise 注册。</span></span><br><span class="line">    <span class="comment">// 如果使用tap注册的话，进行异步操作是不会等待异步操作执行完成的。</span></span><br><span class="line">    compiler.hooks.make.tap(<span class="string">&quot;TestPlugin&quot;</span>, <span class="function">(<span class="params">compilation</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;compiler.make() 111&quot;</span>);</span><br><span class="line">      &#125;, <span class="number">2000</span>);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用tapAsync、tapPromise注册，进行异步操作会等异步操作做完再继续往下执行</span></span><br><span class="line">    compiler.hooks.make.tapAsync(<span class="string">&quot;TestPlugin&quot;</span>, <span class="function">(<span class="params">compilation, callback</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;compiler.make() 222&quot;</span>);</span><br><span class="line">        <span class="comment">// 必须调用</span></span><br><span class="line">        callback();</span><br><span class="line">      &#125;, <span class="number">1000</span>);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    compiler.hooks.make.tapPromise(<span class="string">&quot;TestPlugin&quot;</span>, <span class="function">(<span class="params">compilation</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">&quot;compiler.make() 333&quot;</span>);</span><br><span class="line">      <span class="comment">// 必须返回promise</span></span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123;</span><br><span class="line">        resolve();</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从文档可知, emit 是 AsyncSeriesHook, 也就是异步串行钩子，特点就是异步任务顺序执行</span></span><br><span class="line">    compiler.hooks.emit.tapAsync(<span class="string">&quot;TestPlugin&quot;</span>, <span class="function">(<span class="params">compilation, callback</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;compiler.emit() 111&quot;</span>);</span><br><span class="line">        callback();</span><br><span class="line">      &#125;, <span class="number">3000</span>);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    compiler.hooks.emit.tapAsync(<span class="string">&quot;TestPlugin&quot;</span>, <span class="function">(<span class="params">compilation, callback</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;compiler.emit() 222&quot;</span>);</span><br><span class="line">        callback();</span><br><span class="line">      &#125;, <span class="number">2000</span>);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    compiler.hooks.emit.tapAsync(<span class="string">&quot;TestPlugin&quot;</span>, <span class="function">(<span class="params">compilation, callback</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;compiler.emit() 333&quot;</span>);</span><br><span class="line">        callback();</span><br><span class="line">      &#125;, <span class="number">1000</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = TestPlugin;</span><br></pre></td></tr></table></figure>



<h3 id="启动调试"><a href="#启动调试" class="headerlink" title="启动调试"></a>启动调试</h3><p>通过调试查看 <code>compiler</code> 和 <code>compilation</code> 对象数据情况。</p>
<ol>
<li>package.json 配置指令</li>
</ol>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;source&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;version&quot;</span>: <span class="string">&quot;1.0.0&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;scripts&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;debug&quot;</span>: <span class="string">&quot;node --inspect-brk ./node_modules/webpack-cli/bin/cli.js&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;keywords&quot;</span>: [],</span><br><span class="line">  <span class="attr">&quot;author&quot;</span>: <span class="string">&quot;xiongjian&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;license&quot;</span>: <span class="string">&quot;ISC&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;devDependencies&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;@babel/core&quot;</span>: <span class="string">&quot;^7.17.10&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;@babel/preset-env&quot;</span>: <span class="string">&quot;^7.17.10&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;css-loader&quot;</span>: <span class="string">&quot;^6.7.1&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;loader-utils&quot;</span>: <span class="string">&quot;^3.2.0&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;webpack&quot;</span>: <span class="string">&quot;^5.72.0&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;webpack-cli&quot;</span>: <span class="string">&quot;^4.9.2&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>运行指令</li>
</ol>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm run debug</span><br></pre></td></tr></table></figure>

<p>此时控制台输出以下内容：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">PS C:\Users\86176\Desktop\source&gt; npm run debug</span><br><span class="line"></span><br><span class="line">&gt; source@1.0.0 debug</span><br><span class="line">&gt; node --inspect-brk ./node_modules/webpack-cli/bin/cli.js</span><br><span class="line"></span><br><span class="line">Debugger listening on ws://127.0.0.1:9229/629ea097-7b52-4011-93a7-02f83c75c797</span><br><span class="line">For help, see: https://nodejs.org/en/docs/inspecto</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>打开 Chrome 浏览器，F12 打开浏览器调试控制台。</li>
</ol>
<p>此时控制台会显示一个绿色的图标</p>
<p><img src="http://192.168.0.102:8080/imgs/source/debug.png" alt="调试控制台"></p>
<ol start="4">
<li><p>点击绿色的图标进入调试模式。</p>
</li>
<li><p>在需要调试代码处用 <code>debugger</code> 打断点，代码就会停止运行，从而调试查看数据情况。</p>
</li>
</ol>
<h2 id="BannerWebpackPlugin"><a href="#BannerWebpackPlugin" class="headerlink" title="BannerWebpackPlugin"></a>BannerWebpackPlugin</h2><ol>
<li>作用：给打包输出文件添加注释。</li>
<li>开发思路:</li>
</ol>
<ul>
<li>需要打包输出前添加注释：需要使用 <code>compiler.hooks.emit</code> 钩子, 它是打包输出前触发。</li>
<li>如何获取打包输出的资源？<code>compilation.assets</code> 可以获取所有即将输出的资源文件。</li>
</ul>
<ol start="3">
<li>实现：</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// plugins/banner-webpack-plugin.js</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BannerWebpackPlugin</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">options = &#123;&#125;</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.options = options;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">apply</span>(<span class="params">compiler</span>)</span> &#123;</span><br><span class="line">    <span class="comment">// 需要处理文件</span></span><br><span class="line">    <span class="keyword">const</span> extensions = [<span class="string">&quot;js&quot;</span>, <span class="string">&quot;css&quot;</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// emit是异步串行钩子</span></span><br><span class="line">    compiler.hooks.emit.tapAsync(<span class="string">&quot;BannerWebpackPlugin&quot;</span>, <span class="function">(<span class="params">compilation, callback</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// compilation.assets包含所有即将输出的资源</span></span><br><span class="line">      <span class="comment">// 通过过滤只保留需要处理的文件</span></span><br><span class="line">      <span class="keyword">const</span> assetPaths = <span class="built_in">Object</span>.keys(compilation.assets).filter(<span class="function">(<span class="params">path</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> splitted = path.split(<span class="string">&quot;.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> extensions.includes(splitted[splitted.length - <span class="number">1</span>]);</span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">      assetPaths.forEach(<span class="function">(<span class="params">assetPath</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> asset = compilation.assets[assetPath];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> source = <span class="string">`/*</span></span><br><span class="line"><span class="string">* Author: <span class="subst">$&#123;<span class="built_in">this</span>.options.author&#125;</span></span></span><br><span class="line"><span class="string">*/\n<span class="subst">$&#123;asset.source()&#125;</span>`</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 覆盖资源</span></span><br><span class="line">        compilation.assets[assetPath] = &#123;</span><br><span class="line">          <span class="comment">// 资源内容</span></span><br><span class="line">          <span class="function"><span class="title">source</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> source;</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="comment">// 资源大小</span></span><br><span class="line">          <span class="function"><span class="title">size</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> source.length;</span><br><span class="line">          &#125;,</span><br><span class="line">        &#125;;</span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">      callback();</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = BannerWebpackPlugin;</span><br></pre></td></tr></table></figure>





<h2 id="CleanWebpackPlugin"><a href="#CleanWebpackPlugin" class="headerlink" title="CleanWebpackPlugin"></a>CleanWebpackPlugin</h2><ol>
<li>作用：在 webpack 打包输出前将上次打包内容清空。</li>
<li>开发思路：</li>
</ol>
<ul>
<li>如何在打包输出前执行？需要使用 <code>compiler.hooks.emit</code> 钩子, 它是打包输出前触发。</li>
<li>如何清空上次打包内容？<ul>
<li>获取打包输出目录：通过 compiler 对象。</li>
<li>通过文件操作清空内容：通过 <code>compiler.outputFileSystem</code> 操作文件。</li>
</ul>
</li>
</ul>
<ol start="3">
<li>实现：</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// plugins/clean-webpack-plugin.js</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CleanWebpackPlugin</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">apply</span>(<span class="params">compiler</span>)</span> &#123;</span><br><span class="line">    <span class="comment">// 获取操作文件的对象</span></span><br><span class="line">    <span class="keyword">const</span> fs = compiler.outputFileSystem;</span><br><span class="line">    <span class="comment">// emit是异步串行钩子</span></span><br><span class="line">    compiler.hooks.emit.tapAsync(<span class="string">&quot;CleanWebpackPlugin&quot;</span>, <span class="function">(<span class="params">compilation, callback</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// 获取输出文件目录</span></span><br><span class="line">      <span class="keyword">const</span> outputPath = compiler.options.output.path;</span><br><span class="line">      <span class="comment">// 删除目录所有文件</span></span><br><span class="line">      <span class="keyword">const</span> err = <span class="built_in">this</span>.removeFiles(fs, outputPath);</span><br><span class="line">      <span class="comment">// 执行成功err为undefined，执行失败err就是错误原因</span></span><br><span class="line">      callback(err);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">removeFiles</span>(<span class="params">fs, path</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// 读取当前目录下所有文件</span></span><br><span class="line">      <span class="keyword">const</span> files = fs.readdirSync(path);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 遍历文件，删除</span></span><br><span class="line">      files.forEach(<span class="function">(<span class="params">file</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 获取文件完整路径</span></span><br><span class="line">        <span class="keyword">const</span> filePath = <span class="string">`<span class="subst">$&#123;path&#125;</span>/<span class="subst">$&#123;file&#125;</span>`</span>;</span><br><span class="line">        <span class="comment">// 分析文件</span></span><br><span class="line">        <span class="keyword">const</span> fileStat = fs.statSync(filePath);</span><br><span class="line">        <span class="comment">// 判断是否是文件夹</span></span><br><span class="line">        <span class="keyword">if</span> (fileStat.isDirectory()) &#123;</span><br><span class="line">          <span class="comment">// 是文件夹需要递归遍历删除下面所有文件</span></span><br><span class="line">          <span class="built_in">this</span>.removeFiles(fs, filePath);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// 不是文件夹就是文件，直接删除</span></span><br><span class="line">          fs.unlinkSync(filePath);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 最后删除当前目录</span></span><br><span class="line">      fs.rmdirSync(path);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      <span class="comment">// 将产生的错误返回出去</span></span><br><span class="line">      <span class="keyword">return</span> e;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = CleanWebpackPlugin;</span><br></pre></td></tr></table></figure>



<h2 id="AnalyzeWebpackPlugin"><a href="#AnalyzeWebpackPlugin" class="headerlink" title="AnalyzeWebpackPlugin"></a>AnalyzeWebpackPlugin</h2><ol>
<li>作用：分析 webpack 打包资源大小，并输出分析文件。</li>
<li>开发思路:</li>
</ol>
<ul>
<li>在哪做? <code>compiler.hooks.emit</code>, 它是在打包输出前触发，我们需要分析资源大小同时添加上分析后的 md 文件。</li>
</ul>
<ol start="3">
<li>实现：</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// plugins/analyze-webpack-plugin.js</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AnalyzeWebpackPlugin</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">apply</span>(<span class="params">compiler</span>)</span> &#123;</span><br><span class="line">    <span class="comment">// emit是异步串行钩子</span></span><br><span class="line">    compiler.hooks.emit.tap(<span class="string">&quot;AnalyzeWebpackPlugin&quot;</span>, <span class="function">(<span class="params">compilation</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// Object.entries将对象变成二维数组。二维数组中第一项值是key，第二项值是value</span></span><br><span class="line">      <span class="keyword">const</span> assets = <span class="built_in">Object</span>.entries(compilation.assets);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">let</span> source = <span class="string">&quot;# 分析打包资源大小 \n| 名称 | 大小 |\n| --- | --- |&quot;</span>;</span><br><span class="line"></span><br><span class="line">      assets.forEach(<span class="function">(<span class="params">[filename, file]</span>) =&gt;</span> &#123;</span><br><span class="line">        source += <span class="string">`\n| <span class="subst">$&#123;filename&#125;</span> | <span class="subst">$&#123;file.size()&#125;</span> |`</span>;</span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 添加资源</span></span><br><span class="line">      compilation.assets[<span class="string">&quot;analyze.md&quot;</span>] = &#123;</span><br><span class="line">        <span class="function"><span class="title">source</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> source;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="function"><span class="title">size</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> source.length;</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = AnalyzeWebpackPlugin;</span><br></pre></td></tr></table></figure>



<h2 id="InlineChunkWebpackPlugin"><a href="#InlineChunkWebpackPlugin" class="headerlink" title="InlineChunkWebpackPlugin"></a>InlineChunkWebpackPlugin</h2><ol>
<li>作用：webpack 打包生成的 runtime 文件太小了，额外发送请求性能不好，所以需要将其内联到 js 中，从而减少请求数量。</li>
<li>开发思路:</li>
</ol>
<ul>
<li>我们需要借助<code>html-webpack-plugin</code>来实现<ul>
<li>在 <code>html-webpack-plugin</code> 输出 index.html 前将内联 runtime 注入进去</li>
<li>删除多余的 runtime 文件</li>
</ul>
</li>
<li>如何操作 <code>html-webpack-plugin</code>？<a target="_blank" rel="noopener" href="https://github.com/jantimon/html-webpack-plugin/#afteremit-hook">官方文档</a></li>
</ul>
<ol start="3">
<li>实现：</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// plugins/inline-chunk-webpack-plugin.js</span></span><br><span class="line"><span class="keyword">const</span> HtmlWebpackPlugin = <span class="built_in">require</span>(<span class="string">&quot;safe-require&quot;</span>)(<span class="string">&quot;html-webpack-plugin&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">InlineChunkWebpackPlugin</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">tests</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.tests = tests;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">apply</span>(<span class="params">compiler</span>)</span> &#123;</span><br><span class="line">    compiler.hooks.compilation.tap(<span class="string">&quot;InlineChunkWebpackPlugin&quot;</span>, <span class="function">(<span class="params">compilation</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> hooks = HtmlWebpackPlugin.getHooks(compilation);</span><br><span class="line"></span><br><span class="line">      hooks.alterAssetTagGroups.tap(<span class="string">&quot;InlineChunkWebpackPlugin&quot;</span>, <span class="function">(<span class="params">assets</span>) =&gt;</span> &#123;</span><br><span class="line">        assets.headTags = <span class="built_in">this</span>.getInlineTag(assets.headTags, compilation.assets);</span><br><span class="line">        assets.bodyTags = <span class="built_in">this</span>.getInlineTag(assets.bodyTags, compilation.assets);</span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">      hooks.afterEmit.tap(<span class="string">&quot;InlineChunkHtmlPlugin&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">Object</span>.keys(compilation.assets).forEach(<span class="function">(<span class="params">assetName</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (<span class="built_in">this</span>.tests.some(<span class="function">(<span class="params">test</span>) =&gt;</span> assetName.match(test))) &#123;</span><br><span class="line">            <span class="keyword">delete</span> compilation.assets[assetName];</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">getInlineTag</span>(<span class="params">tags, assets</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> tags.map(<span class="function">(<span class="params">tag</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (tag.tagName !== <span class="string">&quot;script&quot;</span>) <span class="keyword">return</span> tag;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> scriptName = tag.attributes.src;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!<span class="built_in">this</span>.tests.some(<span class="function">(<span class="params">test</span>) =&gt;</span> scriptName.match(test))) <span class="keyword">return</span> tag;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> &#123; <span class="attr">tagName</span>: <span class="string">&quot;script&quot;</span>, <span class="attr">innerHTML</span>: assets[scriptName].source(), <span class="attr">closeTag</span>: <span class="literal">true</span> &#125;;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = InlineChunkWebpackPlugin;</span><br></pre></td></tr></table></figure>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="http://example.com">erha</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2023/02/06/webpack%E9%AB%98%E7%BA%A7/">http://example.com/2023/02/06/webpack%E9%AB%98%E7%BA%A7/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">erha blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/webpack/">webpack</a></div><div class="post_share"><div class="social-share" data-image="https://pic.imgdb.cn/item/63dfbedd4757feff33d34240.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/02/06/webpack%E5%A4%84%E7%90%86vue%E9%A1%B9%E7%9B%AE/" title="webpack打包vue项目"><img class="cover" src="https://pic.imgdb.cn/item/63dfbedd4757feff33d34240.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">webpack打包vue项目</div></div></a></div><div class="next-post pull-right"><a href="/2023/02/06/webpack%E4%BC%98%E5%8C%96/" title="webpack优化"><img class="cover" src="https://pic.imgdb.cn/item/63dfbedd4757feff33d34226.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">webpack优化</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2023/02/05/webpack/" title="webpack基本概念"><img class="cover" src="https://pic.imgdb.cn/item/63dfbedd4757feff33d34226.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-02-05</div><div class="title">webpack基本概念</div></div></a></div><div><a href="/2023/02/06/webpack%E5%A4%84%E7%90%86vue%E9%A1%B9%E7%9B%AE/" title="webpack打包vue项目"><img class="cover" src="https://pic.imgdb.cn/item/63dfbedd4757feff33d34240.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-02-06</div><div class="title">webpack打包vue项目</div></div></a></div><div><a href="/2023/02/06/webpack%E7%94%9F%E4%BA%A7%E6%A8%A1%E5%BC%8F/" title="webpack生产模式配置"><img class="cover" src="https://pic.imgdb.cn/item/63dfbedd4757feff33d34240.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-02-06</div><div class="title">webpack生产模式配置</div></div></a></div><div><a href="/2023/02/06/webpack%E5%BC%80%E5%8F%91%E6%A8%A1%E5%BC%8F/" title="webpack开发模式配置"><img class="cover" src="https://pic.imgdb.cn/item/63dfbedd4757feff33d34226.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-02-06</div><div class="title">webpack开发模式配置</div></div></a></div><div><a href="/2023/02/06/webpack%E4%BC%98%E5%8C%96/" title="webpack优化"><img class="cover" src="https://pic.imgdb.cn/item/63dfbedd4757feff33d34226.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-02-06</div><div class="title">webpack优化</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://pic.imgdb.cn/item/63e0f1d14757feff33865eb7.gif" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">erha</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">53</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">48</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">22</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/erha2777"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/erha2777" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:2777840869@qq.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#loader-%E5%8E%9F%E7%90%86"><span class="toc-text">loader 原理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#loader-%E6%A6%82%E5%BF%B5"><span class="toc-text">loader 概念</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#loader-%E6%89%A7%E8%A1%8C%E9%A1%BA%E5%BA%8F"><span class="toc-text">loader 执行顺序</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%80%E5%8F%91%E4%B8%80%E4%B8%AA-loader"><span class="toc-text">开发一个 loader</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E6%9C%80%E7%AE%80%E5%8D%95%E7%9A%84-loader"><span class="toc-text">1. 最简单的 loader</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-loader-%E6%8E%A5%E5%8F%97%E7%9A%84%E5%8F%82%E6%95%B0"><span class="toc-text">2. loader 接受的参数</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#loader-%E5%88%86%E7%B1%BB"><span class="toc-text">loader 分类</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%90%8C%E6%AD%A5-loader"><span class="toc-text">1. 同步 loader</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%BC%82%E6%AD%A5-loader"><span class="toc-text">2. 异步 loader</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-Raw-Loader"><span class="toc-text">3. Raw Loader</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-Pitching-Loader"><span class="toc-text">4. Pitching Loader</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#loader-API"><span class="toc-text">loader API</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%8B%E5%86%99-clean-log-loader"><span class="toc-text">手写 clean-log-loader</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%8B%E5%86%99-banner-loader"><span class="toc-text">手写 banner-loader</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%8B%E5%86%99-babel-loader"><span class="toc-text">手写 babel-loader</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%8B%E5%86%99-file-loader"><span class="toc-text">手写 file-loader</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%8B%E5%86%99-style-loader"><span class="toc-text">手写 style-loader</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Plugin-%E5%8E%9F%E7%90%86"><span class="toc-text">Plugin 原理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Plugin-%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="toc-text">Plugin 的作用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Plugin-%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="toc-text">Plugin 工作原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Webpack-%E5%86%85%E9%83%A8%E7%9A%84%E9%92%A9%E5%AD%90"><span class="toc-text">Webpack 内部的钩子</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E9%92%A9%E5%AD%90"><span class="toc-text">什么是钩子</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Tapable"><span class="toc-text">Tapable</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Plugin-%E6%9E%84%E5%BB%BA%E5%AF%B9%E8%B1%A1"><span class="toc-text">Plugin 构建对象</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Compiler"><span class="toc-text">Compiler</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Compilation"><span class="toc-text">Compilation</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E7%AE%80%E5%9B%BE"><span class="toc-text">生命周期简图</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%80%E5%8F%91%E4%B8%80%E4%B8%AA%E6%8F%92%E4%BB%B6"><span class="toc-text">开发一个插件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%80%E7%AE%80%E5%8D%95%E7%9A%84%E6%8F%92%E4%BB%B6"><span class="toc-text">最简单的插件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E5%86%8C-hook"><span class="toc-text">注册 hook</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E8%B0%83%E8%AF%95"><span class="toc-text">启动调试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#BannerWebpackPlugin"><span class="toc-text">BannerWebpackPlugin</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CleanWebpackPlugin"><span class="toc-text">CleanWebpackPlugin</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#AnalyzeWebpackPlugin"><span class="toc-text">AnalyzeWebpackPlugin</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#InlineChunkWebpackPlugin"><span class="toc-text">InlineChunkWebpackPlugin</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2023/02/06/TypeScript/" title="TypeScript"><img src="https://pic.imgdb.cn/item/63dfbedd4757feff33d34226.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="TypeScript"/></a><div class="content"><a class="title" href="/2023/02/06/TypeScript/" title="TypeScript">TypeScript</a><time datetime="2023-02-06T10:01:17.813Z" title="发表于 2023-02-06 18:01:17">2023-02-06</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/02/06/webpack%E5%A4%84%E7%90%86vue%E9%A1%B9%E7%9B%AE/" title="webpack打包vue项目"><img src="https://pic.imgdb.cn/item/63dfbedd4757feff33d34240.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="webpack打包vue项目"/></a><div class="content"><a class="title" href="/2023/02/06/webpack%E5%A4%84%E7%90%86vue%E9%A1%B9%E7%9B%AE/" title="webpack打包vue项目">webpack打包vue项目</a><time datetime="2023-02-06T03:17:36.650Z" title="发表于 2023-02-06 11:17:36">2023-02-06</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/02/06/webpack%E9%AB%98%E7%BA%A7/" title="webpack高级"><img src="https://pic.imgdb.cn/item/63dfbedd4757feff33d34240.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="webpack高级"/></a><div class="content"><a class="title" href="/2023/02/06/webpack%E9%AB%98%E7%BA%A7/" title="webpack高级">webpack高级</a><time datetime="2023-02-06T03:17:14.615Z" title="发表于 2023-02-06 11:17:14">2023-02-06</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/02/06/webpack%E4%BC%98%E5%8C%96/" title="webpack优化"><img src="https://pic.imgdb.cn/item/63dfbedd4757feff33d34226.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="webpack优化"/></a><div class="content"><a class="title" href="/2023/02/06/webpack%E4%BC%98%E5%8C%96/" title="webpack优化">webpack优化</a><time datetime="2023-02-06T03:17:03.890Z" title="发表于 2023-02-06 11:17:03">2023-02-06</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/02/06/webpack%E7%94%9F%E4%BA%A7%E6%A8%A1%E5%BC%8F/" title="webpack生产模式配置"><img src="https://pic.imgdb.cn/item/63dfbedd4757feff33d34240.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="webpack生产模式配置"/></a><div class="content"><a class="title" href="/2023/02/06/webpack%E7%94%9F%E4%BA%A7%E6%A8%A1%E5%BC%8F/" title="webpack生产模式配置">webpack生产模式配置</a><time datetime="2023-02-06T03:16:30.278Z" title="发表于 2023-02-06 11:16:30">2023-02-06</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('https://pic.imgdb.cn/item/63dfbedd4757feff33d34240.jpg')"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By erha</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Hi, welcome to my <a target="_blank" rel="noopener" href="https://erha2777.github.io/">blog</a>!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="chat_btn" type="button" title="聊天"><i class="fas fa-sms"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><div class="js-pjax"></div><div class="aplayer no-destroy" data-id="60198" data-server="netease" data-type="playlist" data-fixed="true" data-autoplay="false"> </div><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/fireworks.min.js"></script><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="true"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/metingjs/dist/Meting.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>